<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Background (Jewelry & Small Objects)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        .container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
        img, canvas { max-width: 100%; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Upload Image to Remove Background</h2>
        <input type="file" id="imageInput" accept="image/*">
        <br><br>
        <img id="uploadedImage" class="hidden" alt="Uploaded Image">
        <br><br>
        <button id="removeBgButton">Remove Background</button>
        <br><br>
        <canvas id="outputCanvas" class="hidden"></canvas>
        <br><br>
        <a id="downloadLink" class="hidden" download="background_removed.png">Download Image</a>
    </div>

    <script>
        const imageInput = document.getElementById("imageInput");
        const removeBgButton = document.getElementById("removeBgButton");
        const outputCanvas = document.getElementById("outputCanvas");
        const uploadedImage = document.getElementById("uploadedImage");
        const downloadLink = document.getElementById("downloadLink");

        let img = new Image();

        imageInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                    uploadedImage.src = e.target.result;
                    uploadedImage.classList.remove("hidden");
                };
                reader.readAsDataURL(file);
            }
        });

        removeBgButton.addEventListener("click", async function () {
            if (!img.src) {
                alert("Please upload an image first.");
                return;
            }

            // Load BodyPix model (used for object segmentation)
            const net = await bodyPix.load();
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const segmentation = await net.segmentPerson(canvas, {
                internalResolution: "high",
                segmentationThreshold: 0.7
            });

            const mask = bodyPix.toMask(segmentation);

            const outputCtx = outputCanvas.getContext("2d");
            outputCanvas.width = img.width;
            outputCanvas.height = img.height;
            outputCtx.drawImage(img, 0, 0);

            const imageData = outputCtx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;

            for (let i = 0; i < pixels.length; i += 4) {
                if (mask.data[i] === 0) {
                    pixels[i + 3] = 0; // Set transparency for background pixels
                }
            }

            outputCtx.putImageData(imageData, 0, 0);
            outputCanvas.classList.remove("hidden");

            // Enable download link
            downloadLink.href = outputCanvas.toDataURL();
            downloadLink.classList.remove("hidden");
            downloadLink.textContent = "Download Image";
        });
    </script>

</body>
</html>
